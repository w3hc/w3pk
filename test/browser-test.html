<!DOCTYPE html>
<html>
  <head>
    <title>w3pk SDK Test</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #000000;
        color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans",
          "Helvetica Neue", sans-serif;
        line-height: 1.6;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      h1 {
        color: #ffffff;
        margin-bottom: 30px;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 30px;
      }

      button {
        background: #8c1c84;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      button:hover {
        background: #6d1566;
        transform: translateY(-1px);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #444;
        cursor: not-allowed;
        opacity: 0.5;
      }

      #output {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        min-height: 400px;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 13px;
        line-height: 1.8;
        overflow-y: auto;
        max-height: 600px;
      }

      #output p {
        margin: 8px 0;
        padding: 4px 0;
        border-bottom: 1px solid #222;
      }

      #output p:last-child {
        border-bottom: none;
      }

      .success {
        color: #4ade80;
      }

      .error {
        color: #ef4444;
      }

      .info {
        color: #60a5fa;
      }

      .warning {
        color: #fbbf24;
      }

      strong {
        color: #ffffff;
        font-weight: 600;
      }

      code {
        background: #2a2a2a;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
      }

      .header-info {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
      }

      .header-info p {
        margin: 5px 0;
        font-size: 14px;
      }

      .header-info strong {
        color: #8c1c84;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔐 w3pk SDK Test</h1>

      <div class="header-info">
        <p>
          <strong>Backend:</strong> <span id="backend-url">Loading...</span>
        </p>
        <p>
          <strong>Status:</strong> <span id="sdk-status">Initializing...</span>
        </p>
      </div>

      <div class="controls">
        <button id="generateBtn">🔑 Generate Wallet</button>
        <button id="registerBtn" disabled>📝 Register</button>
        <button id="loginBtn">🔓 Login (Usernameless)</button>
        <button id="signBtn" disabled>✍️ Sign Message</button>
        <button id="logoutBtn">🚪 Logout</button>
        <button id="clearBtn" style="background: #444">🗑️ Clear</button>
      </div>

      <div id="output">
        <p><strong>Console output will appear here...</strong></p>
      </div>
    </div>

    <script type="module">
      // Inline everything to avoid module resolution issues
      const output = document.getElementById("output");
      const backendUrlEl = document.getElementById("backend-url");
      const sdkStatusEl = document.getElementById("sdk-status");
      const registerBtn = document.getElementById("registerBtn");
      const signBtn = document.getElementById("signBtn");
      const generateBtn = document.getElementById("generateBtn");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const clearBtn = document.getElementById("clearBtn");

      function log(message, type = "info") {
        const className =
          type === "error"
            ? "error"
            : type === "success"
            ? "success"
            : type === "warning"
            ? "warning"
            : "info";

        const timestamp = new Date().toLocaleTimeString();
        output.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
        output.scrollTop = output.scrollHeight;
        console.log(message);
      }

      function clearOutput() {
        output.innerHTML = "<p><strong>Console cleared...</strong></p>";
      }

      // Configuration
      const urlParams = new URLSearchParams(window.location.search);
      const API_URL = urlParams.get("api") || "https://webauthn.w3hc.org";
      backendUrlEl.textContent = API_URL;

      // Try to load SDK
      let sdk;
      let testWallet = null;

      try {
        // Dynamic import with error handling
        const module = await import("../dist/index.mjs");
        const { createWeb3Passkey } = module;

        sdk = createWeb3Passkey({
          apiBaseUrl: API_URL,
          debug: true,
          onError: (error) => {
            log(`❌ Error: ${error.message}`, "error");
          },
          onAuthStateChanged: (isAuth, user) => {
            log(
              `🔐 Auth State Changed: ${
                isAuth ? "✅ Authenticated" : "❌ Not Authenticated"
              }`,
              "success"
            );
            if (user) {
              log(
                `👤 User: ${user.username} (${user.ethereumAddress})`,
                "info"
              );
            }
            signBtn.disabled = !isAuth;
          },
        });

        log("✅ SDK initialized successfully", "success");
        log(`📊 Version: ${sdk.version}`, "info");
        log(
          `🔓 Authenticated: ${sdk.isAuthenticated}`,
          sdk.isAuthenticated ? "success" : "warning"
        );
        log(`👤 User: ${sdk.user?.username || "none"}`, "info");
        sdkStatusEl.textContent = "✅ Ready";
      } catch (error) {
        log(`❌ Failed to initialize SDK: ${error.message}`, "error");
        log(`⚠️  Make sure you ran: pnpm build`, "warning");
        sdkStatusEl.textContent = "❌ Failed";
        console.error("SDK initialization error:", error);
      }

      // Generate Wallet
      generateBtn.addEventListener("click", async function () {
        if (!sdk) {
          log("❌ SDK not initialized", "error");
          return;
        }

        try {
          log("🔄 Generating wallet...", "info");
          const wallet = await sdk.generateWallet();
          log(`✅ Wallet generated!`, "success");
          log(`📍 Address: <code>${wallet.address}</code>`, "info");
          log(`🔑 Mnemonic: <code>${wallet.mnemonic}</code>`, "warning");
          log(`⚠️  BACKUP THIS MNEMONIC!`, "warning");

          testWallet = wallet;
          registerBtn.disabled = false;
        } catch (error) {
          log(`❌ Wallet generation failed: ${error.message}`, "error");
          console.error(error);
        }
      });

      // Register
      registerBtn.addEventListener("click", async function () {
        if (!sdk) {
          log("❌ SDK not initialized", "error");
          return;
        }

        if (!testWallet) {
          log("❌ Generate a wallet first!", "error");
          return;
        }

        try {
          const username = prompt("Enter username:", "alice");
          if (!username) return;

          log("🔄 Starting registration...", "info");

          const beginRes = await fetch(`${API_URL}/webauthn/register/begin`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username,
              ethereumAddress: testWallet.address,
            }),
          });

          if (!beginRes.ok) {
            throw new Error(
              `Backend error: ${beginRes.status} - Make sure backend is running on ${API_URL}`
            );
          }

          const beginData = await beginRes.json();
          log("📝 Registration options received", "info");

          // Load SimpleWebAuthn from CDN
          const { startRegistration } = await import(
            "https://unpkg.com/@simplewebauthn/browser@13.2.2/dist/bundle/index.js"
          );
          const credential = await startRegistration(beginData.data.options);
          log("🔐 WebAuthn credential created", "success");

          await sdk.register({
            username,
            ethereumAddress: testWallet.address,
            mnemonic: testWallet.mnemonic,
            credentialId: credential.id,
            challenge: beginData.data.options.challenge,
          });

          log("✅ Registration successful!", "success");
          registerBtn.disabled = true;
        } catch (error) {
          log(`❌ Registration failed: ${error.message}`, "error");
          console.error(error);
        }
      });

      // Login
      loginBtn.addEventListener("click", async function () {
        if (!sdk) {
          log("❌ SDK not initialized", "error");
          return;
        }

        try {
          log("🔄 Starting login...", "info");
          const result = await sdk.authenticateUsernameless();

          if (result.verified) {
            log("✅ Login successful!", "success");
            log(`👤 Logged in as: ${result.user?.username}`, "success");
            log(
              `📍 Address: <code>${result.user?.ethereumAddress}</code>`,
              "info"
            );
          } else {
            log("❌ Login failed - not verified", "error");
          }
        } catch (error) {
          log(`❌ Login failed: ${error.message}`, "error");
          console.error(error);
        }
      });

      // Sign Message
      signBtn.addEventListener("click", async function () {
        if (!sdk) {
          log("❌ SDK not initialized", "error");
          return;
        }

        if (!sdk.isAuthenticated) {
          log("❌ Please login first!", "error");
          return;
        }

        try {
          const message = prompt("Enter message to sign:", "Hello, Web3!");
          if (!message) return;

          log(`🔄 Signing message: "${message}"`, "info");

          const beginRes = await fetch(
            `${API_URL}/webauthn/authenticate/usernameless/begin`,
            {
              method: "POST",
            }
          );

          if (!beginRes.ok) {
            throw new Error(`Backend error: ${beginRes.status}`);
          }

          const beginData = await beginRes.json();

          const { startAuthentication } = await import(
            "https://unpkg.com/@simplewebauthn/browser@13.2.2/dist/bundle/index.js"
          );
          const credential = await startAuthentication(beginData.data.options);
          log("🔐 Authentication successful", "success");

          const signature = await sdk.signMessage(
            message,
            credential.id,
            beginData.data.options.challenge
          );

          log("✅ Message signed successfully!", "success");
          log(
            `✍️  Signature: <code>${signature.substring(
              0,
              20
            )}...${signature.substring(signature.length - 20)}</code>`,
            "info"
          );
        } catch (error) {
          log(`❌ Signing failed: ${error.message}`, "error");
          console.error(error);
        }
      });

      // Logout
      logoutBtn.addEventListener("click", function () {
        if (!sdk) {
          log("❌ SDK not initialized", "error");
          return;
        }

        sdk.logout();
        log("✅ Logged out", "success");
        signBtn.disabled = true;
      });

      // Clear
      clearBtn.addEventListener("click", clearOutput);
    </script>
  </body>
</html>
